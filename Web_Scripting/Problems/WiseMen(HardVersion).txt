Wise Men (Hard Version)                    

https://codeforces.com/problemset/problem/1326/F2

bitmasks

3200

This is the hard version of the problem. The difference is constraints on the number of wise men and the time limit. You can make hacks only if all versions of this task are solved.n wise men live in a beautiful city. Some of them know each other.For each of the n! possible permutations p_1, p_2, \ldots, p_n of the wise men, let's generate a binary string of length n-1: for each 1 \leq i < n set s_i=1 if p_i and p_{i+1} know each other, and s_i=0 otherwise. For all possible 2^{n-1} binary strings, find the number of permutations that produce this binary string.