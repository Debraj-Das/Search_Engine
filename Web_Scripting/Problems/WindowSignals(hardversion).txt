Window Signals (hard version)                    

https://codeforces.com/problemset/problem/1781/H2



3500

This is the hard version of the problem. In this version, the constraints on h and w are higher.A house at the sea has h floors, all of the same height. The side of the house facing the sea has w windows at equal distances from each other on every floor. Thus, the windows are positioned in cells of a rectangular grid of size h \times w.In every window, the light can be turned either on or off, except for the given k (at most 2) windows. In these k windows the light can not be turned on, because it is broken.In the dark, we can send a signal to a ship at sea using a configuration of lights turned on and off. However, the ship can not see the position of the lights with respect to the house. Thus, if one configuration of windows with lights on can be transformed into another using parallel translation, these configurations are considered equal. Note that only parallel translation is allowed, but neither rotations nor flips are. Moreover, a configuration without any light at all is not considered valid.Find how many different signals the ship can receive and print this number modulo 998\,244\,353.