Square-free division (hard version)                    

https://codeforces.com/problemset/problem/1497/E2

data structures

2500

This is the hard version of the problem. The only difference is that in this version 0 \leq k \leq 20.There is an array a_1, a_2, \ldots, a_n of n positive integers. You should divide it into a minimal number of continuous segments, such that in each segment there are no two numbers (on different positions), whose product is a perfect square.Moreover, it is allowed to do at most k such operations before the division: choose a number in the array and change its value to any positive integer.What is the minimum number of continuous segments you should use if you will make changes optimally?