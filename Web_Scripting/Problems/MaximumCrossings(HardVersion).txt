Maximum Crossings (Hard Version)                    

https://codeforces.com/problemset/problem/1676/H2

data structures

1500

The only difference between the two versions is that in this version n \leq 2 \cdot 10^5 and the sum of n over all test cases does not exceed 2 \cdot 10^5.A terminal is a row of n equal segments numbered 1 to n in order. There are two terminals, one above the other. You are given an array a of length n. For all i = 1, 2, \dots, n, there should be a straight wire from some point on segment i of the top terminal to some point on segment a_i of the bottom terminal. You can't select the endpoints of a segment. For example, the following pictures show two possible wirings if n=7 and a=[4,1,4,6,7,7,5].  A crossing occurs when two wires share a point in common. In the picture above, crossings are circled in red.What is the maximum number of crossings there can be if you place the wires optimally?